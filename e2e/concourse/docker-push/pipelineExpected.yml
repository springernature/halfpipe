# Generated using halfpipe cli version 0.0.0-DEV
jobs:
- build_log_retention:
    minimum_succeeded_builds: 1
  name: push to docker registry
  plan:
  - attempts: 2
    get: git
    timeout: 15m
    trigger: true
  - config:
      image_resource:
        name: ""
        source:
          repository: alpine
        type: docker-image
      inputs:
      - name: git
      outputs:
      - name: tagList
      platform: linux
      run:
        args:
        - -c
        - |-
          GIT_REF=`[ -f git/.git/ref ] && cat git/.git/ref || true`
          VERSION=`[ -f version/version ] && cat version/version || true`
          printf "%s %s latest" "$GIT_REF" "$VERSION" > tagList/tagList
          printf "Image will be tagged with: %s\n" $(cat tagList/tagList)
        path: /bin/sh
    task: create-tag-list
    timeout: 1h
  - config:
      image_resource:
        name: ""
        source:
          repository: concourse/oci-build-task
        type: registry-image
      inputs:
      - name: git
      outputs:
      - name: image
      params:
        BUILD_ARG_A: a
        BUILD_ARG_ARTIFACTORY_PASSWORD: ((artifactory.password))
        BUILD_ARG_ARTIFACTORY_URL: ((artifactory.url))
        BUILD_ARG_ARTIFACTORY_USERNAME: ((artifactory.username))
        BUILD_ARG_B: b
        BUILD_ARG_RUNNING_IN_CI: "true"
        CONTEXT: git/e2e/concourse/docker-push
        DOCKER_CONFIG_JSON: ((halfpipe-gcr.docker_config))
        DOCKERFILE: git/e2e/concourse/docker-push/Dockerfile
      platform: linux
      run:
        args:
        - -c
        - |-
          mkdir ~/.docker
          echo $DOCKER_CONFIG_JSON > ~/.docker/config.json
          build
        path: /bin/sh
    privileged: true
    task: build
    timeout: 1h
  - config:
      image_resource:
        name: ""
        source:
          repository: aquasec/trivy
        type: docker-image
      inputs:
      - name: git
      - name: image
      platform: linux
      run:
        args:
        - -c
        - |-
          [ -f .trivyignore ] && echo "Ignoring the following CVE's due to .trivyignore" || true
          [ -f .trivyignore ] && cat .trivyignore; echo || true
          trivy image --timeout 15m --ignore-unfixed --severity CRITICAL --scanners vuln --exit-code 0 --input ../../../../image/image.tar || true
        dir: git/e2e/concourse/docker-push
        path: /bin/sh
    task: trivy
    timeout: 1h
  - no_get: true
    params:
      additional_tags: tagList/tagList
      image: image/image.tar
    put: halfpipe-fly.thisismy-tag
    timeout: 1h
  serial: true
- build_log_retention:
    minimum_succeeded_builds: 1
  name: docker-push
  plan:
  - attempts: 2
    get: git
    passed:
    - push to docker registry
    timeout: 15m
    trigger: true
  - attempts: 2
    config:
      image_resource:
        name: ""
        source:
          repository: alpine
        type: docker-image
      inputs:
      - name: git
      outputs:
      - name: tagList
      platform: linux
      run:
        args:
        - -c
        - |-
          GIT_REF=`[ -f git/.git/ref ] && cat git/.git/ref || true`
          VERSION=`[ -f version/version ] && cat version/version || true`
          printf "%s %s latest" "$GIT_REF" "$VERSION" > tagList/tagList
          printf "Image will be tagged with: %s\n" $(cat tagList/tagList)
        path: /bin/sh
    task: create-tag-list
    timeout: 1h
  - attempts: 2
    config:
      image_resource:
        name: ""
        source:
          repository: concourse/oci-build-task
        type: registry-image
      inputs:
      - name: git
      outputs:
      - name: image
      params:
        BUILD_ARG_ARTIFACTORY_PASSWORD: ((artifactory.password))
        BUILD_ARG_ARTIFACTORY_URL: ((artifactory.url))
        BUILD_ARG_ARTIFACTORY_USERNAME: ((artifactory.username))
        BUILD_ARG_RUNNING_IN_CI: "true"
        CONTEXT: git/e2e/concourse/docker-push
        DOCKER_CONFIG_JSON: ((halfpipe-gcr.docker_config))
        DOCKERFILE: git/e2e/concourse/docker-push/Dockerfile
      platform: linux
      run:
        args:
        - -c
        - |-
          mkdir ~/.docker
          echo $DOCKER_CONFIG_JSON > ~/.docker/config.json
          build
        path: /bin/sh
    privileged: true
    task: build
    timeout: 1h
  - attempts: 2
    config:
      image_resource:
        name: ""
        source:
          repository: aquasec/trivy
        type: docker-image
      inputs:
      - name: git
      - name: image
      platform: linux
      run:
        args:
        - -c
        - |-
          [ -f .trivyignore ] && echo "Ignoring the following CVE's due to .trivyignore" || true
          [ -f .trivyignore ] && cat .trivyignore; echo || true
          trivy image --timeout 30m --ignore-unfixed --severity CRITICAL --scanners vuln --exit-code 0 --input ../../../../image/image.tar || true
        dir: git/e2e/concourse/docker-push
        path: /bin/sh
    task: trivy
    timeout: 1h
  - attempts: 2
    no_get: true
    params:
      additional_tags: tagList/tagList
      image: image/image.tar
    put: halfpipe-fly.thisismy-tag2
    timeout: 1h
  serial: true
- build_log_retention:
    minimum_succeeded_builds: 1
  name: docker-push (1)
  plan:
  - attempts: 2
    get: git
    passed:
    - docker-push
    timeout: 15m
    trigger: true
  - attempts: 2
    config:
      image_resource:
        name: ""
        source:
          repository: alpine
        type: docker-image
      inputs:
      - name: git
      outputs:
      - name: tagList
      platform: linux
      run:
        args:
        - -c
        - |-
          GIT_REF=`[ -f git/.git/ref ] && cat git/.git/ref || true`
          VERSION=`[ -f version/version ] && cat version/version || true`
          printf "%s %s latest" "$GIT_REF" "$VERSION" > tagList/tagList
          printf "Image will be tagged with: %s\n" $(cat tagList/tagList)
        path: /bin/sh
    task: create-tag-list
    timeout: 1h
  - attempts: 2
    config:
      image_resource:
        name: ""
        source:
          password: ((halfpipe-gcr.private_key))
          repository: eu.gcr.io/halfpipe-io/halfpipe-buildx
          tag: latest
          username: _json_key
        type: registry-image
      inputs:
      - name: git
      - name: tagList
      outputs:
      - name: image
      params:
        BUILD_ARG_ARTIFACTORY_PASSWORD: ((artifactory.password))
        BUILD_ARG_ARTIFACTORY_URL: ((artifactory.url))
        BUILD_ARG_ARTIFACTORY_USERNAME: ((artifactory.username))
        BUILD_ARG_RUNNING_IN_CI: "true"
        CONTEXT: git/e2e/concourse/docker-push
        DOCKER_CONFIG_JSON: ((halfpipe-gcr.docker_config))
        DOCKERFILE: git/e2e/concourse/docker-push/Dockerfile
      platform: linux
      run:
        args:
        - -c
        - |-
          echo $DOCKER_CONFIG_JSON > ~/.docker/config.json
          docker buildx build -f $DOCKERFILE --platform linux/amd64,linux/arm64 -t eu.gcr.io/halfpipe-io/cache/springerplatformengineering/halfpipe_fly:$(cat git/.git/ref) --push --provenance=false $CONTEXT
        path: /bin/sh
    privileged: true
    task: build
    timeout: 1h
  - attempts: 2
    config:
      image_resource:
        name: ""
        source:
          repository: aquasec/trivy
        type: docker-image
      inputs:
      - name: git
      - name: image
      platform: linux
      run:
        args:
        - -c
        - |-
          [ -f .trivyignore ] && echo "Ignoring the following CVE's due to .trivyignore" || true
          [ -f .trivyignore ] && cat .trivyignore; echo || true
          trivy image --timeout 30m --ignore-unfixed --severity CRITICAL --scanners vuln --exit-code 0 eu.gcr.io/halfpipe-io/cache/springerplatformengineering/halfpipe_fly:$(cat git/.git/ref) || true
        path: /bin/sh
    task: trivy
    timeout: 1h
  - attempts: 2
    config:
      image_resource:
        name: ""
        source:
          password: ((halfpipe-gcr.private_key))
          repository: eu.gcr.io/halfpipe-io/halfpipe-buildx
          tag: latest
          username: _json_key
        type: registry-image
      inputs:
      - name: git
      - name: tagList
      outputs:
      - name: image
      params:
        BUILD_ARG_ARTIFACTORY_PASSWORD: ((artifactory.password))
        BUILD_ARG_ARTIFACTORY_URL: ((artifactory.url))
        BUILD_ARG_ARTIFACTORY_USERNAME: ((artifactory.username))
        BUILD_ARG_RUNNING_IN_CI: "true"
        CONTEXT: git/e2e/concourse/docker-push
        DOCKER_CONFIG_JSON: ((halfpipe-gcr.docker_config))
        DOCKERFILE: git/e2e/concourse/docker-push/Dockerfile
      platform: linux
      run:
        args:
        - -c
        - |-
          echo $DOCKER_CONFIG_JSON > ~/.docker/config.json
          for tag in $(cat tagList/tagList) thisIsMy_Tag2; do docker buildx imagetools create eu.gcr.io/halfpipe-io/cache/springerplatformengineering/halfpipe_fly:$(cat git/.git/ref) --tag springerplatformengineering/halfpipe_fly:$tag; done
        path: /bin/sh
    privileged: true
    task: publish-final-image
    timeout: 1h
  serial: true
resources:
- check_every: 10m0s
  name: git
  source:
    branch: main
    paths:
    - e2e/concourse/docker-push
    private_key: ((halfpipe-github.private_key))
    uri: git@github.com:springernature/halfpipe.git
  type: git
- check_every: 24h0m0s
  name: halfpipe-fly.thisismy-tag
  source:
    password: verysecret
    repository: springerplatformengineering/halfpipe_fly:thisIsMy_Tag
    username: rob
  type: registry-image
- check_every: 24h0m0s
  name: halfpipe-fly.thisismy-tag2
  source:
    password: verysecret
    repository: springerplatformengineering/halfpipe_fly:thisIsMy_Tag2
    username: rob
  type: registry-image
